{% extends "base.html" %}

{% block title %}Заявка #{{ ticket.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Заявка #{{ ticket.id }}</h2>

    <ul class="list-group mb-4">
        <li class="list-group-item"><strong>Отправитель:</strong> {{ ticket.sender }}</li>
        <li class="list-group-item"><strong>Тема:</strong> {{ ticket.subject }}</li>
        <li class="list-group-item"><strong>Описание:</strong><br>{{ ticket.body }}</li>
        <li class="list-group-item"><strong>Статус:</strong> {{ ticket.status }}</li>
        <li class="list-group-item"><strong>Дата создания:</strong> {{ ticket.created_at }}</li>
        <li class="list-group-item"><strong>Ответственный:</strong> 
            {% if ticket.assigned_username %}
                {{ ticket.assigned_username }}
            {% else %}
                Не назначен
            {% endif %}
        </li>
    </ul>

    {% if session["role"] in ["admin", "user"] %}
    <form method="POST" class="mb-3">
        <div class="mb-3">
            <label for="status" class="form-label">Изменить статус:</label>
            <select name="status" class="form-select" required>
                <option value="новая" {% if ticket.status == 'новая' %}selected{% endif %}>Новая</option>
                <option value="в работе" {% if ticket.status == 'в работе' %}selected{% endif %}>В работе</option>
                <option value="завершена" {% if ticket.status == 'завершена' %}selected{% endif %}>Завершена</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="assigned_to" class="form-label">Ответственный пользователь:</label>
            <select name="assigned_to" class="form-select">
                <option value="">Не назначать</option>
                {% for user in users %}
                    <option value="{{ user.id }}" {% if ticket.assigned_to == user.id %}selected{% endif %}>
                        {{ user.username }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Обновить</button>
    </form>
    {% endif %}

    <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Назад к списку заявок</a>
</div>
{% endblock %}
